# Whisper-Input-Next 异步转录队列改进

## 背景
- 之前 `Ctrl+F` / `Ctrl+I` 触发的录音在 `main.py` 中同步调用转录服务，直到返回结果才能进行下一次录音，导致等待期间快捷键不再出现 `0/1` 状态提示，也无法开始新一轮录音。
- 需求：录音一结束就立即让后台开始转录，同时允许用户继续按快捷键录制下一段，失败时仍然可以保留音频并手动重试。

## 核心变更
- **转录任务队列**：新增 `TranscriptionJob` 数据类和 `queue.Queue`，用来封装音频字节流、目标处理器、模式及重试标记（`main.py:27`, `main.py:104`）。
- **后台工作线程**：`VoiceAssistant` 初始化时启动守护线程 `_job_worker`，持续从队列中取任务并调用 `_run_job` 串行执行（`main.py:72`, `main.py:135`）。
- **录音/转录解耦**：停止录音时立刻把缓冲转换为字节并排队；录音流程不再等待 API 回应（`main.py:229`, `main.py:259`, `main.py:289`）。
- **重试机制**：保留最近一次失败音频的字节数组，通过 `awaiting_retry`、`retry_in_progress` 控制，用户再次按 `Ctrl+F` 时会重新入队，成功后清空缓存（`main.py:55`, `main.py:200`, `main.py:209`）。
- **键盘交互不变**：`KeyboardManager` 的状态更新逻辑未改动，继续负责显示 `0/1`、错误提示及将识别文本粘贴到当前光标位置。

## 使用方式
1. 按 `Ctrl+F`（OpenAI）或 `Ctrl+I`（本地 whisper）开始录音，再次按键结束，录音立即排队进入后台转录。
2. 在上一段仍在处理时可以立刻开始下一段录音；所有转录任务会顺序输出结果。
3. 若某个任务失败，终端会提示 `!`，并保留音频；再次按 `Ctrl+F` 会触发重试，无需重新录音。
4. 翻译模式（`Ctrl` + 配置键）同样受益于队列机制，录音完毕后直接异步翻译。

## 兼容性与存档
- 原有的音频归档、识别结果缓存、日志记录等逻辑均保持不变，仍会在 `audio_archive/` 下生成文件，日志继续写入 `logs/app.log`。
- 由于转录仍在单线程队列中执行，不会同时占用多个模型实例，不需要额外的并发限流配置。

## 后续可拓展方向
- 根据需要可以在队列中记录任务耗时，或在日志/界面中增加排队进度提示。
- 若未来启用并行处理，可在 `_job_worker` 基础上扩展为线程池，但需要同步更新模型调用的配额与资源管控策略。
