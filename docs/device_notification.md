# 音频设备断开通知功能

## 功能说明

当麦克风设备在录音启动时出现问题（例如外部麦克风断开），程序会自动发送 macOS 系统通知提醒用户。

## 通知内容

- **标题**: ⚠️ 音频设备错误
- **副标题**: 录音启动失败
- **消息**: 麦克风可能已断开，请检查设备连接

## 工作原理

1. 当用户按下录音快捷键时，程序尝试启动录音
2. 如果音频设备不可用（例如外部麦克风已断开），`sounddevice` 会抛出异常
3. 程序捕获异常后：
   - 记录错误日志
   - 发送系统通知提醒用户
   - 继续抛出异常以保持正常的错误处理流程

## 测试方法

### 方法 1: 使用测试脚本

运行通知功能测试脚本：

```bash
source .venv/bin/activate
python test/test_recorder_notification.py
```

### 方法 2: 手动测试

1. 连接外部麦克风（耳机麦克风等）
2. 启动程序：`python main.py`
3. 在录音过程中拔掉外部麦克风
4. 尝试开始新的录音
5. 观察是否收到系统通知

### 方法 3: 使用基础通知测试

测试系统通知是否正常工作：

```bash
source .venv/bin/activate
python test/test_notification.py
```

## 注意事项

1. **通知权限**: 确保终端应用（Terminal、iTerm2 等）有通知权限
   - 系统设置 -> 通知 -> [你的终端应用]
   - 确保通知已开启且设置为"横幅"或"提醒"

2. **非阻塞**: 通知发送是异步的，不会阻塞录音流程

3. **静默失败**: 如果通知发送失败，只会记录 debug 日志，不影响主程序

4. **仅在启动失败时触发**: 只有在 `start_recording()` 失败时才会发送通知

## 代码位置

- **通知方法**: `src/audio/recorder.py:95-120` (`_send_notification`)
- **调用位置**: `src/audio/recorder.py:154-166` (在 `start_recording` 的异常处理中)

## 常见场景

### 场景 1: 外部麦克风断开
- **情况**: 用户使用外部耳机录音时突然拔掉耳机
- **表现**: 下次尝试录音时会收到通知
- **解决**: 重新插入麦克风或使用系统内置麦克风

### 场景 2: 麦克风权限被禁用
- **情况**: 用户在系统设置中禁用了麦克风权限
- **表现**: 尝试录音时收到通知
- **解决**: 在系统设置中重新授予麦克风权限

### 场景 3: 设备被其他应用占用
- **情况**: 麦克风被其他应用独占使用
- **表现**: 尝试录音时收到通知
- **解决**: 关闭占用麦克风的应用
